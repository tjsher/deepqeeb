# DeepQeeb 设计方案讨论

## 问题分析与解决方案

---

## 一、IDE 布局设计

### 问题
- 左侧文件目录，右侧对话框
- 用户需要查看文件内容，但对话框也要保留
- 文件查看和对话框的占比如何分配？

### 解决方案：三栏可变布局

```
┌─────────────────┬─────────────────┬─────────────────┐
│                 │                 │                 │
│   文件目录      │    文件内容     │    对话框       │
│   (15-20%)      │    (可变)       │    (可变)       │
│                 │                 │                 │
├─────────────────┴─────────────────┴─────────────────┤
│                 底部状态栏/工具栏                    │
└─────────────────────────────────────────────────────┘
```

**交互逻辑：**
1. **默认状态**：文件目录(15%) + 对话框(85%)
2. **点击文件**：文件目录(15%) + 文件内容(45%) + 对话框(40%)
3. **拖拽调整**：三栏边界可拖拽调整宽度
4. **全屏模式**：
   - 点击对话框的「全屏」→ 文件目录隐藏，对话框占右侧 100%
   - 点击文件内容的「全屏」→ 对话框最小化（保留输入框）

---

## 二、对话历史管理

### 问题
- 需要查看历史记录
- 能随时续聊
- 能创建新对话
- Agent A（剧本生成）和 Agent B（游戏生成）的对话是否要分开？

### 解决方案：对话列表 + Session 机制

**数据模型（Supabase）：**

```typescript
// conversations 表
interface Conversation {
  id: string;              // UUID
  user_id: string;         // 用户ID（匿名或登录）
  type: 'script' | 'game'; // 对话类型：剧本 / 游戏
  title: string;           // 对话标题（自动生成，如"赛博朋克解谜游戏"）
  status: 'active' | 'archived';
  created_at: timestamp;
  updated_at: timestamp;
  last_message_at: timestamp;
  
  // 关联的文件（剧本阶段）
  files?: ScriptFile[];
  
  // 关联的游戏（游戏阶段）
  games?: GameVersion[];
}

// messages 表
interface Message {
  id: string;
  conversation_id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  attachments?: Attachment[];  // 图片等多模态
  created_at: timestamp;
}
```

**UI 设计：**

```
文件目录区域新增「对话列表」标签：
┌──────────────┐
│ 📁 文件      │
│ 💬 对话记录  │ ← 点击切换标签
├──────────────┤
│ + 新对话     │ ← 创建新对话
├──────────────┤
│ 📝 赛博朋克  │ ← 最近对话
│    2分钟前   │
│ 🎮 武侠冒险  │ ← 另一个对话
│    昨天      │
└──────────────┘
```

**工作流：**
1. 用户创建新对话 → 生成新的 conversation_id
2. 在剧本阶段（Agent A），所有文件操作都关联到该对话
3. 点击历史对话 → 加载该对话的所有文件和消息，可续聊
4. 进入游戏阶段 → 从剧本对话「fork」出一个 game 类型的新对话

---

## 三、游戏预览与分享管理

### 问题
- 游戏文件不应该在文件目录中显示
- 需要预览功能
- 可能生成多个游戏版本
- 多次分享（多个链接）如何管理？

### 解决方案：独立游戏版本管理

**数据模型：**

```typescript
// games 表（游戏版本）
interface GameVersion {
  id: string;
  conversation_id: string;   // 关联的剧本对话
  version: number;           // 版本号（v1, v2, v3...）
  code: string;              // 完整的 ESM HTML 代码
  preview_url?: string;      // 预览用的 blob/data URL（本地临时）
  created_at: timestamp;
  description?: string;      // 版本说明（用户可编辑，如"修复了战斗bug"）
}

// shares 表（分享链接）
interface ShareLink {
  id: string;                // 短 ID（如 /share/abc123）
  game_id: string;           // 关联的游戏版本
  created_at: timestamp;
  access_count: number;      // 访问统计
  expires_at?: timestamp;    // 可选过期时间
}
```

**UI 设计 - 游戏预览侧边栏：**

```
对话框上方新增「游戏版本」面板（可折叠）：

┌────────────────────────────────────────┐
│ 🎮 游戏版本管理          [v]          │ ← 可折叠
├────────────────────────────────────────┤
│ 版本历史:                              │
│ ┌────────┬────────┬────────┐          │
│ │  v1    │  v2    │  v3   │ ← 标签切换 │
│ │ 预览   │ 预览   │ 预览   │          │
│ └────────┴────────┴────────┘          │
│                                        │
│ [🖥️ 全屏预览]  [🔗 分享链接] [⬇️ 下载] │
├────────────────────────────────────────┤
│ 当前版本分享链接:                      │
│ https://deepqeeb.vercel.app/s/abc123  │
│ [复制] [管理所有链接]                  │
└────────────────────────────────────────┘
```

**分享管理弹窗：**

```
┌────────────────────────────────────────┐
│          分享链接管理                  │
├────────────────────────────────────────┤
│ v1 - 初始版本                          │
│   └─ /s/abc123  [复制] [删除] [统计]   │
│   └─ /s/def456  [复制] [删除] [统计]   │
│                                        │
│ v2 - 修复bug版                         │
│   └─ /s/ghi789  [复制] [删除] [统计]   │
│                                        │
│ [+ 为此版本创建新链接]                  │
└────────────────────────────────────────┘
```

**技术实现：**

1. **预览**：使用 `<iframe srcdoc={gameCode}>` 实时渲染，不占用文件目录
2. **分享**：
   - 点击「分享」→ 将 `game.code` 存入 Supabase → 生成短 ID
   - 访问 `/share/[id]` → 服务端从 Supabase 取出 code → 直接返回 HTML
3. **版本管理**：
   - 每次用户说"生成游戏" → 创建新的 GameVersion
   - 可以对比不同版本，回滚到旧版本
4. **一个版本多个链接**：
   - 支持为同一版本生成多个分享链接
   - 每个链接独立统计访问数据
   - 可单独删除某个链接，不影响其他链接

---

## 四、整体页面路由结构

```
/                    → 首页（自动跳转或展示功能介绍）
/chat/[id]           → IDE 主界面（剧本阶段）
  - 左侧：文件目录 + 对话历史列表
  - 右侧：对话框 + 可选的文件查看面板
  - 底部：游戏版本预览面板（当进入游戏阶段时显示）

/share/[id]          → 独立游戏页面（被分享的游戏）
  - 只显示游戏，无 IDE 界面
  - 支持全屏游玩

/api/chat            → AI 流式接口（Agent A 和 Agent B）
/api/share           → 创建分享链接
```

---

## 五、下一步建议

按照以下顺序实现：

1. **基础 UI 框架**
   - 三栏布局组件（可拖拽调整）
   - 文件目录树组件
   - 对话框组件

2. **剧本阶段（Agent A）**
   - 实现文件增删改查功能
   - 对接 AI 流式接口
   - 实现对话历史列表

3. **游戏阶段（Agent B）**
   - iframe 预览组件
   - 游戏版本管理面板
   - 分享功能

4. **优化**
   - 响应式适配（移动端简化版）
   - 访问统计
   - 用户系统（可选）

你觉得这个设计方案如何？有哪些地方需要调整？
